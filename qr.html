<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>QR読取サンプル</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    #reader { width: 300px; margin: 10px auto; }
    #result { margin-top: 20px; text-align: center; }
    button { padding: 10px 20px; margin: 5px; }
    #closeBtn { display: none; }
  </style>
</head>
<body>
  <div style="text-align:center;">
    <button onclick="startScan()">読取</button>
    <button id="closeBtn" onclick="stopScan()">閉じる</button>
    <div id="reader"></div>
    <div id="result"></div>
  </div>

  <script>
    let qrScanner = null;

    function startScan() {
      // 既存のスキャナがあれば停止＆削除
      if (qrScanner) {
        qrScanner.stop().then(() => qrScanner.clear()).catch(()=>{});
        qrScanner = null;
        document.getElementById("reader").innerHTML = "";
      }

      // 新しいインスタンスを作る
      qrScanner = new Html5Qrcode("reader");

      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
      );

      document.getElementById("closeBtn").style.display = "inline-block";
    }

    function stopScan() {
      if (qrScanner) {
        qrScanner.stop().then(() => qrScanner.clear()).then(() => {
          document.getElementById("reader").innerHTML = "";
          document.getElementById("closeBtn").style.display = "none";
          qrScanner = null; // 再生成できるようにリセット
        }).catch(()=>{});
      }
    }

    function onScanSuccess(decodedText) {
      stopScan();
      showResult(decodedText);
    }

    function showResult(url) {
      const result = document.getElementById("result");
      result.innerHTML = "";
      if (url.match(/\.wav$/i)) {
        result.innerHTML = `<audio autoplay src="${url}"></audio>`;
      } else if (url.match(/\.(jpg|png)$/i)) {
        result.innerHTML = `<img src="${url}" style="max-width:90%;">`;
      } else {
        result.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
      }
    }
  </script>
</body>
</html>
