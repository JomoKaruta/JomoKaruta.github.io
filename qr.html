<script>
  let qrScanner;

  function startScan() {
    if (!qrScanner) {
      qrScanner = new Html5Qrcode("reader");
    } else {
      // 既存のスキャナを一度クリア
      qrScanner.clear().catch(() => {});
      qrScanner = new Html5Qrcode("reader");
    }

    qrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScanSuccess
    );
  }

  function onScanSuccess(decodedText) {
    qrScanner.stop().then(() => {
      showResult(decodedText);
    });
  }

  function showResult(url) {
    const result = document.getElementById("result");
    result.innerHTML = "";
    if (url.match(/\.(wav)$/i)) {
      result.innerHTML = `<audio controls autoplay src="${url}"></audio>`;
    } else if (url.match(/\.(jpg|png)$/i)) {
      result.innerHTML = `<img src="${url}" style="max-width:90%;">`;
    } else {
      result.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
    }
  }
</script>
